# Story 01.02: Dynamic Routing Implementation

## Status
Approved

## Story
**As a** developer implementing the tools documentation system,
**I want** to create dynamic routing for tool pages with mobile-first responsive design using existing Tailwind v4.1 utilities,
**so that** users can navigate to individual tool pages via `/tools/{tool-id}/` and `/tools/{tool-id}/{slug}` routes with proper error handling and SEO optimization.

## Story Overview

**Story Title**: Dynamic Routing Implementation  
**Story Goal**: Implement dynamic routing for tool pages with mobile-first responsive design  
**Epic**: Tools Documentation System - Brownfield Enhancement  
**Story Type**: Infrastructure Setup  
**Estimated Duration**: 1-2 days  
**Priority**: High (Foundation)

## Story Context

This story implements dynamic routing for the tools documentation system, creating individual tool pages and post pages with flat URL structure. The implementation leverages existing Astro SSG infrastructure, existing Tailwind v4.1 responsive utilities, and maintains backward compatibility with existing `/docs/` routes. The routing system will support both tool landing pages (`/tools/anki/`) and individual post pages (`/tools/anki/sentence-mining`).

## Acceptance Criteria

- [ ] **Dynamic Tool Landing Pages**: Implement routing for `/tools/{tool-id}/` pages using existing Astro dynamic routes
- [ ] **Individual Post Routing**: Implement routing for `/tools/{tool-id}/{slug}` pages with proper slug handling
- [ ] **Mobile-First Responsive Design**: Implement using existing Tailwind v4.1 utilities (sm:, md:, lg:, xl: breakpoints)
- [ ] **URL Structure**: Maintain flat hierarchy with proper URL structure and SEO-friendly slugs
- [ ] **Error Handling**: Implement 404 pages and fallbacks for invalid routes
- [ ] **Performance Optimization**: Use existing Astro SSG optimizations with proper lazy loading
- [ ] **SEO-Friendly URLs**: Implement proper meta tags and structured data using existing HeadSEO component
- [ ] **Responsive Navigation**: Create mobile-first navigation components using existing Tailwind utilities
- [ ] **Breadcrumb System**: Implement responsive breadcrumbs for navigation context
- [ ] **Backward Compatibility**: Ensure existing `/docs/` routes remain functional and separate

## Tasks / Subtasks

### 1. Dynamic Route Structure Implementation (Sequential)
- [ ] **Create Tool Landing Page Route** (AC: 1)
  - [ ] Create `src/pages/tools/[toolId]/index.astro` for tool landing pages
  - [ ] Implement dynamic route parameter handling using existing Astro patterns
  - [ ] Add route validation for valid tool IDs (anki, yomitan, migaku, language-reactor)
  - [ ] Implement 404 fallback for invalid tool IDs
- [ ] **Create Individual Post Route** (AC: 2)
  - [ ] Create `src/pages/tools/[toolId]/[slug].astro` for individual post pages
  - [ ] Implement slug parameter handling with proper URL encoding
  - [ ] Add slug validation and sanitization using existing security patterns
  - [ ] Implement 404 fallback for invalid slugs
- [ ] **Route Validation and Error Handling** (AC: 5)
  - [ ] Implement route parameter validation using existing validation patterns
  - [ ] Create custom 404 pages for tools routes using existing error page patterns
  - [ ] Add proper error logging and monitoring using existing logging infrastructure
  - [ ] Test error scenarios with invalid routes and parameters

### 2. Mobile-First Responsive Layout Implementation (Using Existing Infrastructure)
- [ ] **Responsive Layout System** (AC: 3)
  - [ ] Create responsive layout components using existing Tailwind breakpoints (sm: 640px, md: 768px, lg: 1024px, xl: 1280px)
  - [ ] Implement mobile-first grid layouts using existing Tailwind grid utilities
  - [ ] Add responsive typography using existing Tailwind text utilities
  - [ ] Ensure touch targets meet 44px minimum requirement (existing standard)
- [ ] **Responsive Navigation Components** (AC: 8)
  - [ ] Create mobile-first navigation menu using existing Navbar component patterns
  - [ ] Implement responsive tool navigation using existing Tailwind responsive classes
  - [ ] Add mobile hamburger menu using existing responsive patterns
  - [ ] Ensure keyboard navigation accessibility using existing accessibility patterns
- [ ] **Breadcrumb System** (AC: 9)
  - [ ] Create responsive breadcrumb component using existing Tailwind utilities
  - [ ] Implement breadcrumb navigation for tool and post pages
  - [ ] Add mobile-optimized breadcrumb display using existing responsive patterns
  - [ ] Ensure breadcrumb accessibility with proper ARIA labels

### 3. SEO and Performance Optimization (Using Existing Infrastructure)
- [ ] **SEO Meta Tags Implementation** (AC: 7)
  - [ ] Integrate existing HeadSEO component for dynamic meta tags
  - [ ] Implement dynamic title and description generation using existing patterns
  - [ ] Add structured data (JSON-LD) using existing structured data patterns
  - [ ] Implement Open Graph and Twitter Card meta tags using existing patterns
- [ ] **Performance Optimization** (AC: 6)
  - [ ] Implement lazy loading for tool content using existing Astro lazy loading patterns
  - [ ] Add proper resource hints using existing prefetch patterns
  - [ ] Optimize image loading using existing image optimization patterns
  - [ ] Implement code splitting using existing Astro build optimization patterns
- [ ] **URL Structure and SEO** (AC: 4)
  - [ ] Implement SEO-friendly URL generation using existing slug patterns
  - [ ] Add proper canonical URLs using existing canonical URL patterns
  - [ ] Implement sitemap generation for tools routes using existing sitemap patterns
  - [ ] Add robots.txt directives for tools routes using existing robots.txt patterns

### 4. Content Integration and Data Flow (Using Existing Infrastructure)
- [ ] **Content Collection Integration** (AC: 1, 2)
  - [ ] Integrate with existing toolsCollection from `src/content/config.ts`
  - [ ] Implement content filtering by tool ID using existing content query patterns
  - [ ] Add content sorting and pagination using existing pagination patterns
  - [ ] Implement content search functionality using existing search patterns
- [ ] **Data Validation and Security** (AC: 5)
  - [ ] Implement route parameter sanitization using existing security patterns
  - [ ] Add content validation using existing schema validation patterns
  - [ ] Implement XSS prevention using existing DOMPurify patterns
  - [ ] Add input validation for dynamic routes using existing validation patterns

### 5. Testing and Validation (Using Existing Infrastructure)
- [ ] **Route Testing** (AC: 5)
  - [ ] Test all dynamic routes with valid and invalid parameters
  - [ ] Verify 404 handling for invalid routes using existing testing patterns
  - [ ] Test URL encoding and decoding using existing URL handling patterns
  - [ ] Validate route performance using existing performance testing patterns
- [ ] **Responsive Design Testing** (AC: 3, 8, 9)
  - [ ] Test responsive layouts across all breakpoints using existing responsive testing patterns
  - [ ] Verify touch target accessibility using existing accessibility testing patterns
  - [ ] Test mobile navigation functionality using existing mobile testing patterns
  - [ ] Validate breadcrumb navigation across devices using existing navigation testing patterns
- [ ] **SEO and Performance Testing** (AC: 6, 7)
  - [ ] Test meta tag generation using existing SEO testing patterns
  - [ ] Verify structured data implementation using existing structured data testing patterns
  - [ ] Test performance metrics using existing Lighthouse testing patterns
  - [ ] Validate sitemap generation using existing sitemap testing patterns

## Technical Implementation

### 1. Dynamic Route Structure Implementation

**Objective**: Create dynamic routing for tool pages and individual posts

**Implementation Steps**:

1. **Tool Landing Page Route** (`src/pages/tools/[toolId]/index.astro`):
   ```astro
   ---
   // src/pages/tools/[toolId]/index.astro
   import { getCollection } from 'astro:content';
   import { toolsCollection } from '../../content/config';
   import BaseLayout from '../../../layouts/BaseLayout.astro';
   import Head from '../../../components/public-components/HeadSEO.astro';
   import Navbar from '../../../components/public-components/Navbar.vue';
   
   // Dynamic route parameter
   export async function getStaticPaths() {
     const tools = await getCollection('tools');
     const toolIds = [...new Set(tools.map(tool => tool.data.toolName.toLowerCase()))];
     
     return toolIds.map(toolId => ({
       params: { toolId },
       props: { toolId }
     }));
   }
   
   const { toolId } = Astro.params;
   const tools = await getCollection('tools');
   const toolContent = tools.filter(tool => 
     tool.data.toolName.toLowerCase() === toolId
   );
   
   if (!toolContent.length) {
     return Astro.redirect('/404');
   }
   
   const toolData = toolContent[0].data;
   ---
   
   <!doctype html>
   <html lang="id">
     <head>
       <Head
         title={`${toolData.toolName} - Tools Documentation`}
         description={toolData.description}
         pageType="website"
         publishedDate={toolData.publishedDate}
         lang="id"
         aiPageType="tools"
         enableAIOptimizations={true}
       />
     </head>
     <body>
       <Navbar client:visible />
       
       <main class="main-content">
         <!-- Tool Hero Section -->
         <section class="tool-hero">
           <div class="container mx-auto px-4 sm:px-6 lg:px-8">
             <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white">
               {toolData.toolName}
             </h1>
             <p class="mt-4 text-lg sm:text-xl text-gray-300">
               {toolData.description}
             </p>
           </div>
         </section>
         
         <!-- Tool Content Grid -->
         <section class="tool-content">
           <div class="container mx-auto px-4 sm:px-6 lg:px-8">
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
               {toolContent.map(post => (
                 <article class="tool-post-card">
                   <h2 class="text-xl font-semibold text-white">
                     {post.data.title}
                   </h2>
                   <p class="text-gray-300 mt-2">
                     {post.data.description}
                   </p>
                   <a href={`/tools/${toolId}/${post.slug}`} class="mt-4 inline-block">
                     Read More
                   </a>
                 </article>
               ))}
             </div>
           </div>
         </section>
       </main>
     </body>
   </html>
   ```

2. **Individual Post Route** (`src/pages/tools/[toolId]/[slug].astro`):
   ```astro
   ---
   // src/pages/tools/[toolId]/[slug].astro
   import { getCollection } from 'astro:content';
   import { toolsCollection } from '../../content/config';
   import BaseLayout from '../../../layouts/BaseLayout.astro';
   import Head from '../../../components/public-components/HeadSEO.astro';
   import Navbar from '../../../components/public-components/Navbar.vue';
   
   // Dynamic route parameters
   export async function getStaticPaths() {
     const tools = await getCollection('tools');
     
     return tools.map(tool => ({
       params: { 
         toolId: tool.data.toolName.toLowerCase(),
         slug: tool.slug 
       },
       props: { tool }
     }));
   }
   
   const { toolId, slug } = Astro.params;
   const { tool } = Astro.props;
   
   if (!tool) {
     return Astro.redirect('/404');
   }
   
   const { Content } = await tool.render();
   ---
   
   <!doctype html>
   <html lang="id">
     <head>
       <Head
         title={`${tool.data.title} - ${tool.data.toolName}`}
         description={tool.data.description}
         pageType="article"
         publishedDate={tool.data.publishedDate}
         lang="id"
         aiPageType="tools"
         enableAIOptimizations={true}
       />
     </head>
     <body>
       <Navbar client:visible />
       
       <main class="main-content">
         <!-- Breadcrumb Navigation -->
         <nav class="breadcrumb-nav">
           <div class="container mx-auto px-4 sm:px-6 lg:px-8">
             <ol class="flex items-center space-x-2 text-sm sm:text-base">
               <li><a href="/tools" class="text-gray-400 hover:text-white">Tools</a></li>
               <li class="text-gray-400">/</li>
               <li><a href={`/tools/${toolId}`} class="text-gray-400 hover:text-white">{tool.data.toolName}</a></li>
               <li class="text-gray-400">/</li>
               <li class="text-white">{tool.data.title}</li>
             </ol>
           </div>
         </nav>
         
         <!-- Article Content -->
         <article class="article-content">
           <div class="container mx-auto px-4 sm:px-6 lg:px-8">
             <header class="article-header">
               <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white">
                 {tool.data.title}
               </h1>
               <div class="mt-4 flex flex-wrap items-center gap-4 text-sm sm:text-base text-gray-300">
                 <span>By {tool.data.author}</span>
                 <span>•</span>
                 <span>{tool.data.publishedDate}</span>
                 {tool.data.readTime && (
                   <>
                     <span>•</span>
                     <span>{tool.data.readTime} min read</span>
                   </>
                 )}
               </div>
             </header>
             
             <div class="article-body mt-8 prose prose-invert max-w-none">
               <Content />
             </div>
           </div>
         </article>
       </main>
     </body>
   </html>
   ```

### 2. Mobile-First Responsive Design Implementation

**Objective**: Implement responsive design using existing Tailwind v4.1 utilities

**Implementation Steps**:

1. **Responsive Layout Components**:
   ```astro
   <!-- Responsive Container System -->
   <div class="container mx-auto px-4 sm:px-6 lg:px-8">
     <!-- Mobile-first responsive grid -->
     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 lg:gap-8">
       <!-- Tool cards with responsive design -->
     </div>
   </div>
   
   <!-- Responsive Typography System -->
   <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-white">
     Tool Documentation
   </h1>
   
   <p class="text-sm sm:text-base lg:text-lg text-gray-300">
     Responsive description text
   </p>
   
   <!-- Responsive Navigation -->
   <nav class="flex flex-col sm:flex-row lg:flex-col xl:flex-row gap-2 sm:gap-4">
     <a href="#" class="px-3 py-2 sm:px-4 sm:py-3 text-sm sm:text-base">
       Navigation Item
     </a>
   </nav>
   
   <!-- Responsive Breadcrumbs -->
   <ol class="flex flex-wrap items-center space-x-1 sm:space-x-2 text-xs sm:text-sm lg:text-base">
     <li><a href="#" class="text-gray-400 hover:text-white">Home</a></li>
     <li class="text-gray-400">/</li>
     <li><a href="#" class="text-gray-400 hover:text-white">Tools</a></li>
   </ol>
   ```

2. **Touch Target Implementation**:
   ```astro
   <!-- Touch targets meeting 44px minimum -->
   <button class="min-h-[44px] px-4 py-2 sm:px-6 sm:py-3 text-sm sm:text-base">
     Interactive Button
   </button>
   
   <a href="#" class="block min-h-[44px] px-4 py-2 sm:px-6 sm:py-3 text-sm sm:text-base">
     Touch-friendly Link
   </a>
   ```

### 3. Error Handling and Fallbacks

**Objective**: Implement proper error handling for invalid routes

**Implementation Steps**:

1. **Custom 404 Page for Tools** (`src/pages/tools/404.astro`):
   ```astro
   ---
   // src/pages/tools/404.astro
   import BaseLayout from '../../layouts/BaseLayout.astro';
   import Head from '../../components/public-components/HeadSEO.astro';
   import Navbar from '../../components/public-components/Navbar.vue';
   ---
   
   <!doctype html>
   <html lang="id">
     <head>
       <Head
         title="Tool Not Found - Tools Documentation"
         description="The requested tool documentation could not be found."
         pageType="website"
         lang="id"
         aiPageType="tools"
         enableAIOptimizations={true}
       />
     </head>
     <body>
       <Navbar client:visible />
       
       <main class="main-content">
         <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16">
           <div class="text-center">
             <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-white mb-4">
               Tool Not Found
             </h1>
             <p class="text-lg sm:text-xl text-gray-300 mb-8">
               The tool documentation you're looking for doesn't exist.
             </p>
             <a href="/tools" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
               Browse All Tools
             </a>
           </div>
         </div>
       </main>
     </body>
   </html>
   ```

### 4. SEO and Performance Optimization

**Objective**: Implement SEO optimization using existing infrastructure

**Implementation Steps**:

1. **Dynamic Meta Tags**:
   ```astro
   ---
   // Dynamic meta tag generation using existing HeadSEO component
   <Head
     title={`${toolData.title} - ${toolData.toolName} Documentation`}
     description={toolData.description}
     pageType="article"
     publishedDate={toolData.publishedDate}
     lang="id"
     aiPageType="tools"
     enableAIOptimizations={true}
   />
   ---
   ```

2. **Structured Data Implementation**:
   ```astro
   <script type="application/ld+json" set:html={JSON.stringify({
     "@context": "https://schema.org",
     "@type": "Article",
     "headline": toolData.title,
     "description": toolData.description,
     "author": {
       "@type": "Person",
       "name": toolData.author
     },
     "datePublished": toolData.publishedDate,
     "publisher": {
       "@type": "Organization",
       "name": "GoRakuDo"
     }
   })} />
   ```

## Dev Notes

### Relevant Source Tree
```
src/
├── pages/
│   ├── tools/
│   │   ├── [toolId]/
│   │   │   ├── index.astro (NEW - tool landing pages)
│   │   │   └── [slug].astro (NEW - individual post pages)
│   │   └── 404.astro (NEW - tools 404 page)
│   └── tools.astro (existing - tools overview page)
├── content/
│   ├── config.ts (existing - toolsCollection schema)
│   └── tools/ (existing - tool content)
├── components/
│   └── public-components/
│       ├── HeadSEO.astro (existing - SEO component)
│       └── Navbar.vue (existing - navigation component)
├── layouts/
│   └── BaseLayout.astro (existing - base layout)
└── styles/
    └── global.css (existing - global styles)
```

### Architecture Alignment
- **Current State**: Existing Astro SSG with static routes in `/docs/`
- **Enhancement Strategy**: Add dynamic routes in `/tools/` while preserving existing `/docs/` routes
- **Integration Points**: 
  - Extend existing Astro routing system with dynamic routes
  - Use existing HeadSEO component for meta tags
  - Leverage existing Navbar component for navigation
  - Use existing BaseLayout for consistent styling
- **Backward Compatibility**: All existing `/docs/` routes remain functional and separate

### Dynamic Routing Strategy
- **Tool Landing Pages**: `/tools/{toolId}/` - Display all content for a specific tool
- **Individual Posts**: `/tools/{toolId}/{slug}` - Display specific post content
- **Error Handling**: Custom 404 pages for invalid routes
- **SEO Optimization**: Dynamic meta tags and structured data
- **Performance**: Leverage existing Astro SSG optimizations

### Mobile-First Responsive Design
- **Existing Infrastructure**: Tailwind CSS v4.1 with responsive utilities
- **Breakpoints**: sm: 640px, md: 768px, lg: 1024px, xl: 1280px
- **Touch Targets**: Minimum 44px for mobile accessibility
- **Navigation**: Responsive navigation with mobile hamburger menu
- **Breadcrumbs**: Mobile-optimized breadcrumb navigation

### SEO and Performance
- **Meta Tags**: Dynamic generation using existing HeadSEO component
- **Structured Data**: JSON-LD implementation for articles
- **Performance**: Lazy loading and code splitting using existing Astro optimizations
- **Sitemap**: Integration with existing sitemap generation
- **Robots.txt**: Proper directives for tools routes

### Security Considerations
- **Route Validation**: Parameter sanitization and validation
- **Content Security**: XSS prevention using existing DOMPurify patterns
- **Input Validation**: Proper validation for dynamic route parameters
- **Error Handling**: Secure error pages without information disclosure

### Testing Standards
- **Route Testing**: Test all dynamic routes with valid and invalid parameters
- **Responsive Testing**: Test across all breakpoints using existing responsive testing patterns
- **Performance Testing**: Use existing Lighthouse testing patterns
- **SEO Testing**: Validate meta tags and structured data using existing SEO testing patterns
- **Accessibility Testing**: Test keyboard navigation and screen reader compatibility

## Definition of Done

- [ ] Dynamic routing implemented for `/tools/{toolId}/` and `/tools/{toolId}/{slug}` pages
- [ ] Mobile-first responsive design using existing Tailwind v4.1 utilities
- [ ] Error handling and 404 pages implemented for invalid routes
- [ ] SEO optimization with dynamic meta tags and structured data
- [ ] Performance optimization with lazy loading and code splitting
- [ ] Responsive navigation and breadcrumb system implemented
- [ ] All existing `/docs/` routes remain functional and separate
- [ ] Touch targets meet 44px minimum requirement
- [ ] Keyboard navigation and accessibility requirements met
- [ ] Comprehensive testing completed across all breakpoints

## Testing Requirements

### Route Testing
- [ ] Test all dynamic routes with valid tool IDs and slugs
- [ ] Verify 404 handling for invalid routes
- [ ] Test URL encoding and decoding
- [ ] Validate route performance and loading times

### Responsive Design Testing
- [ ] Test responsive layouts across all breakpoints (320px, 640px, 768px, 1024px, 1280px+)
- [ ] Verify touch target accessibility (44px minimum)
- [ ] Test mobile navigation functionality
- [ ] Validate breadcrumb navigation across devices

### SEO and Performance Testing
- [ ] Test dynamic meta tag generation
- [ ] Verify structured data implementation
- [ ] Test performance metrics using Lighthouse
- [ ] Validate sitemap generation for tools routes

### Accessibility Testing
- [ ] Test keyboard navigation for all interactive elements
- [ ] Verify screen reader compatibility
- [ ] Test color contrast compliance
- [ ] Validate ARIA labels and semantic HTML

## Risk Mitigation

**Primary Risk**: Breaking existing `/docs/` routes during dynamic route implementation  
**Mitigation**: Implement new routes alongside existing ones, maintain separate routing systems  
**Rollback Plan**: Git branches for safe deployment, existing routes remain intact

**Secondary Risk**: Performance degradation from dynamic routing  
**Mitigation**: Leverage existing Astro SSG optimizations, implement proper lazy loading  
**Rollback Plan**: Performance monitoring, optimization procedures

**Tertiary Risk**: SEO conflicts between `/docs/` and `/tools/` routes  
**Mitigation**: Separate SEO optimization, proper canonical URLs, distinct sitemaps  
**Rollback Plan**: SEO monitoring, canonical URL management

## Dependencies

- Existing Astro SSG infrastructure and routing system
- Existing toolsCollection from `src/content/config.ts`
- Existing HeadSEO component for meta tag generation
- Existing Navbar component for navigation
- Existing BaseLayout for consistent styling
- Existing Tailwind CSS v4.1 responsive utilities
- Existing `/docs/` routes functionality (must remain separate)

## Success Metrics

- [ ] All dynamic routes functional with proper error handling
- [ ] Mobile-first responsive design working across all breakpoints
- [ ] SEO optimization implemented with proper meta tags and structured data
- [ ] Performance maintained or improved compared to existing routes
- [ ] Accessibility requirements met for all interactive elements
- [ ] Existing `/docs/` routes remain functional and separate
- [ ] Touch targets meet 44px minimum requirement
- [ ] Comprehensive testing completed with no critical issues

## Next Steps

After completion of this story:
1. Proceed to Story 01.03: Tools.astro Page Updates
2. Test integration between new dynamic routes and existing tools page
3. Validate SEO performance and search engine indexing
4. Monitor performance metrics and user navigation patterns

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-25 | 1.0 | Initial story creation with template format | PO Agent |
| 2025-01-25 | 1.1 | Added comprehensive technical implementation details | PO Agent |
| 2025-01-25 | 1.2 | Added mobile-first responsive design implementation | PO Agent |
| 2025-01-25 | 1.3 | Added SEO and performance optimization details | PO Agent |
| 2025-01-25 | 1.4 | Added error handling and fallback implementation | PO Agent |
| 2025-01-25 | 1.5 | Added testing requirements and validation procedures | PO Agent |

## Dev Agent Record

### Agent Model Used
[To be populated by Dev Agent]

### Debug Log References
[To be populated by Dev Agent]

### Completion Notes List
[To be populated by Dev Agent]

### File List
[To be populated by Dev Agent]

## QA Results
[To be populated by QA Agent]
